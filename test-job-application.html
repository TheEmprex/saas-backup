<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <title>Job Application Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .hidden { display: none; }
        #notification-popup { position: fixed; top: 20px; right: 20px; background: white; border: 1px solid #ccc; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Job Application Test</h1>
    <p>This is a standalone test of the job application AJAX functionality.</p>

    <form id="job-application-form" action="/marketplace/jobs/1/apply" method="POST">
        <div class="form-group">
            <label for="cover_letter">Cover Letter:</label>
            <textarea id="cover_letter" name="cover_letter" rows="4" placeholder="Tell the employer why you're perfect for this job..." required></textarea>
        </div>

        <div class="form-group">
            <label for="proposed_rate">Proposed Rate ($):</label>
            <input type="number" id="proposed_rate" name="proposed_rate" step="0.01" placeholder="25.00" required>
        </div>

        <div class="form-group">
            <label for="available_hours">Available Hours per Week:</label>
            <input type="number" id="available_hours" name="available_hours" min="1" max="80" placeholder="40" required>
        </div>

        <button type="submit" id="submit-application">Submit Application</button>
    </form>

    <!-- Notification Popup -->
    <div id="notification-popup" class="hidden">
        <div>
            <p id="popup-title" class="success"></p>
            <p id="popup-message"></p>
            <button type="button" onclick="closeNotification()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
    </div>

    <script>
        function showNotification(title, message, type = 'success') {
            const popup = document.getElementById('notification-popup');
            const popupTitle = document.getElementById('popup-title');
            const popupMessage = document.getElementById('popup-message');
            
            popupTitle.textContent = title;
            popupMessage.textContent = message;
            popupTitle.className = type;
            
            popup.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                closeNotification();
            }, 5000);
        }

        function closeNotification() {
            const popup = document.getElementById('notification-popup');
            popup.classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Job application AJAX script loaded');
            
            const applicationForm = document.getElementById('job-application-form');
            if (applicationForm) {
                console.log('Application form found');
                applicationForm.addEventListener('submit', function(e) {
                    console.log('Form submission intercepted');
                    e.preventDefault();
                    
                    const submitButton = document.getElementById('submit-application');
                    const formData = new FormData(this);
                    
                    // Disable submit button and show loading state
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]');
                    if (!csrfToken) {
                        console.error('CSRF token not found');
                        showNotification('Error', 'Security token not found. Please refresh the page.', 'error');
                        resetSubmitButton();
                        return;
                    }
                    
                    console.log('Sending AJAX request to /debug-job-apply/1');
                    
                    // Submit via AJAX using debug route
                    fetch('/debug-job-apply/1', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRF-TOKEN': csrfToken.getAttribute('content')
                        }
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            showNotification('Application Sent!', data.message || 'Your application has been submitted successfully!', 'success');
                            
                            // Hide the form and show success message
                            this.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <h3>Application Submitted!</h3>
                                    <p>Your application has been sent to the employer. You'll be notified if they're interested.</p>
                                </div>
                            `;
                        } else {
                            showNotification('Error', data.error || 'An error occurred while submitting your application.', 'error');
                            resetSubmitButton();
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        showNotification('Error', 'An unexpected error occurred. Please try again.', 'error');
                        resetSubmitButton();
                    });
                });
                
                function resetSubmitButton() {
                    const submitButton = document.getElementById('submit-application');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit Application';
                    }
                }
            } else {
                console.log('No application form found on this page');
            }
        });
    </script>
</body>
</html>
