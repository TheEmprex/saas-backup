var e=(e,t,i)=>new Promise((n,l)=>{var s=e=>{try{o(i.next(e))}catch(t){l(t)}},a=e=>{try{o(i.throw(e))}catch(t){l(t)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,a);o((i=i.apply(e,t)).next())});class t{constructor(){this.localStream=null,this.remoteStream=null,this.peerConnection=null,this.isCallActive=!1,this.isMuted=!1,this.isVideoOff=!1,this.currentCall=null,this.configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]},this.init()}init(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&setTimeout(()=>{setInterval(()=>this.checkIncomingCalls(),2e3)},5e3)}startAudioCall(){return e(this,null,function*(){try{yield this.startCall("audio")}catch(e){alert("Could not start audio call. Please check your microphone permissions.")}})}startVideoCall(){return e(this,null,function*(){try{yield this.startCall("video")}catch(e){alert("Could not start video call. Please check your camera and microphone permissions.")}})}startCall(t="audio"){return e(this,null,function*(){if(this.isCallActive)alert("A call is already in progress");else try{const e={audio:!0,video:"video"===t};if(this.localStream=yield navigator.mediaDevices.getUserMedia(e),this.showCallModal(t),"video"===t){const e=document.getElementById("local-video");e&&(e.srcObject=this.localStream)}this.peerConnection=new RTCPeerConnection(this.configuration),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),this.peerConnection.ontrack=e=>{const t=document.getElementById("remote-video");t&&e.streams[0]&&(t.srcObject=e.streams[0])},this.peerConnection.onicecandidate=e=>{e.candidate&&this.sendSignal({type:"ice-candidate",candidate:e.candidate})};const i=yield this.peerConnection.createOffer();yield this.peerConnection.setLocalDescription(i),yield this.sendSignal({type:"offer",offer:i,callType:t}),this.isCallActive=!0,this.currentCall={type:t,status:"outgoing"}}catch(e){throw this.endCall(),e}})}handleIncomingCall(t){return e(this,null,function*(){if(this.isCallActive)return void(yield this.sendSignal({type:"busy",callId:t.id}));confirm(`Incoming ${t.callType} call. Accept?`)?yield this.acceptCall(t):yield this.rejectCall(t)})}acceptCall(t){return e(this,null,function*(){try{const e={audio:!0,video:"video"===t.callType};if(this.localStream=yield navigator.mediaDevices.getUserMedia(e),this.showCallModal(t.callType),"video"===t.callType){const e=document.getElementById("local-video");e&&(e.srcObject=this.localStream)}this.peerConnection=new RTCPeerConnection(this.configuration),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),this.peerConnection.ontrack=e=>{const t=document.getElementById("remote-video");t&&e.streams[0]&&(t.srcObject=e.streams[0])},this.peerConnection.onicecandidate=e=>{e.candidate&&this.sendSignal({type:"ice-candidate",candidate:e.candidate,callId:t.id})},yield this.peerConnection.setRemoteDescription(new RTCSessionDescription(t.offer));const i=yield this.peerConnection.createAnswer();yield this.peerConnection.setLocalDescription(i),yield this.sendSignal({type:"answer",answer:i,callId:t.id}),this.isCallActive=!0,this.currentCall={type:t.callType,status:"incoming",id:t.id}}catch(e){this.endCall()}})}rejectCall(t){return e(this,null,function*(){yield this.sendSignal({type:"reject",callId:t.id})})}endCall(){return e(this,null,function*(){try{this.currentCall&&(yield this.sendSignal({type:"end-call",callId:this.currentCall.id})),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.hideCallModal(),this.isCallActive=!1,this.isMuted=!1,this.isVideoOff=!1,this.currentCall=null}catch(e){}})}toggleAudio(){if(this.localStream){const e=this.localStream.getAudioTracks()[0];if(e){e.enabled=!e.enabled,this.isMuted=!e.enabled;const t=document.getElementById("mute-button");t&&(t.classList.toggle("bg-red-500",this.isMuted),t.classList.toggle("bg-slate-500",!this.isMuted))}}}toggleVideo(){if(this.localStream){const e=this.localStream.getVideoTracks()[0];if(e){e.enabled=!e.enabled,this.isVideoOff=!e.enabled;const t=document.getElementById("video-button");t&&(t.classList.toggle("bg-red-500",this.isVideoOff),t.classList.toggle("bg-slate-500",!this.isVideoOff))}}}showCallModal(e){const t=document.getElementById("call-modal"),i=document.getElementById("video-container"),n=document.getElementById("audio-container");t&&(t.classList.remove("hidden"),"video"===e?(i.classList.remove("hidden"),n.classList.add("hidden")):(n.classList.remove("hidden"),i.classList.add("hidden")))}hideCallModal(){const e=document.getElementById("call-modal");e&&e.classList.add("hidden")}sendSignal(t){return e(this,null,function*(){try{if(!(yield fetch("/api/webrtc/signal",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({signal:t,to_user_id:window.contactUserId||null})})).ok)throw new Error("Failed to send signal")}catch(e){}})}checkIncomingCalls(){return e(this,null,function*(){if(this.isCallActive)return;const e=window.location.pathname;if(e.includes("/login")||e.includes("/register")||"/"===e||e.includes("/auth/"))return;if(!e.includes("/messages"))return;if(document.querySelector('meta[name="csrf-token"]'))try{const e=yield fetch("/api/webrtc/incoming-calls",{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(e.ok){const t=yield e.json();t.calls&&t.calls.length>0&&(yield this.handleIncomingCall(t.calls[0]))}}catch(t){}})}}document.addEventListener("DOMContentLoaded",function(){new t;const e=document.querySelector("[data-contact-id]");e&&(window.contactUserId=e.dataset.contactId)});
